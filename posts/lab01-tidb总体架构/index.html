<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Lab01: TiDB总体架构 - Happy Hacking</title><script>(function(a,b){a[b]=a[b].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="Lab01: TiDB总体架构"><meta property="og:description" content="Prerequisite How we build TiDB 三篇文章了解 TiDB 技术内幕 - 说存储 三篇文章了解 TiDB 技术内幕 - 说计算 三篇文章了解 TiDB 技术内幕 - 谈调度 Problem 本地下载TiDB, TiKV, PD源代码，改写源码并编译部署以下环境： 1 TiDB 1 PD 3 TiKV 改写后 使得TiDB启动事务"><meta property="og:type" content="article"><meta property="og:url" content="/posts/lab01-tidb%E6%80%BB%E4%BD%93%E6%9E%B6%E6%9E%84/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-08-16T20:44:10+08:00"><meta property="article:modified_time" content="2020-08-16T20:44:10+08:00"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Happy Hacking" rel=home><div class="logo__item logo__text"><div class=logo__title>Happy Hacking</div><div class=logo__tagline>Thoughts on computer systems</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/archives><span class=menu__text>Archives</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>About</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Lab01: TiDB总体架构</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2020-08-16T20:44:10+08:00>August 16, 2020</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/high-performance-tidb/ rel=category>High Performance TiDB</a></span></div></div></header><div class="content post__content clearfix"><h2 id=prerequisite>Prerequisite</h2><ul><li><a href=https://pingcap.com/blog-cn/how-do-we-build-tidb/>How we build TiDB</a></li><li><a href=https://pingcap.com/blog-cn/tidb-internal-1/>三篇文章了解 TiDB 技术内幕 - 说存储</a></li><li><a href=https://pingcap.com/blog-cn/tidb-internal-2/>三篇文章了解 TiDB 技术内幕 - 说计算</a></li><li><a href=https://pingcap.com/blog-cn/tidb-internal-3/>三篇文章了解 TiDB 技术内幕 - 谈调度</a></li></ul><h2 id=problem>Problem</h2><blockquote><p>本地下载<code>TiDB</code>, <code>TiKV</code>, <code>PD</code>源代码，改写源码并编译部署以下环境：</p><ul><li>1 TiDB</li><li>1 PD</li><li>3 TiKV</li></ul><p>改写后</p><ul><li>使得TiDB启动事务时，会打一个"hello transaction"的日志</li></ul><p>输出：一篇文章介绍以上过程</p><p>截止时间：本周日24点之前</p><p>作业提交方式：提交至个人github，链接发送给<code>talent-plan@tidb.io</code></p></blockquote><h2 id=howto>HowTo</h2><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ git checkout -b lab01
$ bash build_docker.sh <span style=color:#75715e># build docker images for tidb, pd, and tikv respectively</span>
$ docker-compose up -d
$ tail -f run/logs/tidb0.log <span style=color:#75715e># check the dummy transaction log</span>
$ docker-compose down
</code></pre></div><h2 id=solution>Solution</h2><p>本次作业的两个小目标分别是熟悉<code>TiDB</code>的工程环境搭建和基本的代码流程结构入门。</p><p>对于第一个小目标，借助于<code>docker-compose</code>工具，可以在本地很方便地搭建<code>TiDB</code>集群。具体操作步骤如下，</p><ul><li>分别fork <code>pingcap/tidb</code>, <code>pingcap/pd</code>, <code>tikv/tikv</code>，并clone到本地，编译。<code>TiDB</code>的工程，使用<code>Makefile</code>封装了<code>go build</code>和<code>cargo build</code>的构建逻辑。这里，需要注意的是，在不指定参数直接运行<code>make</code>时，默认的构建目标(target)都是优化后的<code>release</code>版本，如果需要构建其他版本，比如带调试信息的开发版本等，需要查看<code>Makefile</code>获取构建目标。</li><li>准备docker镜像。<code>tidb</code>和<code>pd</code>已经提供了<code>Dockerfile</code>，可以直接使用。<code>tikv</code>没有直接提供<code>Dockerfile</code>，可以参考<a href=https://hub.docker.com/r/pingcap/tikv/dockerfile>docker hub</a>上的<code>Dockerfile</code>。事实上，<code>tikv</code>的<code>Makefile</code>里有一个名为<code>docker</code>的target，也可以创建镜像。笔者封装了一个<a href=https://raw.githubusercontent.com/hftsin/high-performance-tidb/master/build_docker.sh>build_docker.sh</a>的脚本，用来从本地工程开发目录快速创建<code>TiDB</code>的镜像。</li><li>编写<code>docker-compose.yml</code>，配置集群环境。这里参考了<code>pingcap/tidb-docker-compose</code>，本次作业要求配置1个<code>pd</code>实例，3个<code>tikv</code>实例，1个<code>tidb</code>实例。</li><li>测试集群环境。执行<code>docker-compose up -d</code>，可以启动<code>TiDB</code>集群。此时，可以通过查看各服务实例的日志文件，确认各实例都已经正确启动了。执行<code>docker-compose down</code>可以销毁集群。</li></ul><p>对于第二个目标，需要了解<code>TiDB</code>处理事务的基本流程。在<code>PingCAP</code>的官方文档库里，提供了详细的资料以供参考学习。</p><p><code>TiDB</code>支持两种事务使用方式，分别是通过<code>BEGIN/COMMIT</code>来显式使用事务和配置<code>autocommit</code>来隐式使用事务。</p><p><code>TiDB</code>支持乐观锁和悲观锁。以乐观锁为例，刨去细节暂不表，事务处理的基本流程：</p><ol><li>客户端<code>begin</code>一个事务。<code>tidb</code>从<code>pd</code>获取一个全局唯一的递增版本号<code>start_ts</code>。</li><li>处理<code>read request</code>：<code>tidb</code>从<code>pd</code>获取数据所在的<code>kv</code>，请求<code>start_ts</code>版本对于的数据。</li><li>处理<code>write request</code>：<code>tidb</code>本地校验数据，写入内存。</li><li>客户端发起<code>commit</code>，使用<code>2pc</code>将数据写入<code>kv store</code>。</li></ol><p>具体到代码工程结构上，如<a href=https://pingcap.com/blog-cn/tidb-source-code-reading-2/>TiDB源码阅读系列文章（二）源码结构</a>所指出的，<code>store</code>包是封装了底层存储引擎和sql层的交互。真正的事务是在<code>TiKV</code>中实现的，<code>tidb</code>只是封装了一个<code>kv client</code>，通过调用底层的API来实现事务。</p><p>本次作业要求在事务开始时，打印一行日志。因此，可以很直观地从sql语句的执行生命周期入手，寻找事务的开启入口。在 <a href=https://pingcap.com/blog-cn/tidb-source-code-reading-3/>TiDB 源码阅读系列文章（三）SQL 的一生</a>中，<code>session</code>是SQL的核心层。在<code>session</code>中定义了两个事务语义相关的操作<code>StmtCommit</code>和<code>StmtRollback</code>，具体实现都是由成员<code>session.txn</code>代理完成。<code>session.txn</code>是一个<code>TxnState</code>结构，该结构内嵌了一个<code>kv.Transaction</code>成员。<code>kv.Transaction</code>是一个接口类型，封装了底层<code>kv store</code>的事务。进一步追踪，该接口的实现者之一是定义在<code>store/tikv</code>包中的<code>tikvTxn</code>结构。该结构有两个构造函数，分别是<code>newTiKVTxn</code>和<code>newTiKVTxnWithStartTS</code>，其中前者调用了后者。至此，找到了事务的开启入口。</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/tidb/ rel=tag>TiDB</a></li></ul></div></footer></article></main></div><aside class=sidebar><div class="widget-search widget"><form class=widget-search__form role=search method=get action=https://google.com/search><label><input class=widget-search__field type=search placeholder=SEARCH… name=q aria-label=SEARCH…></label>
<input class=widget-search__submit type=submit value=Search>
<input type=hidden name=sitesearch value=/></form></div><div class="widget-recent widget"><h4 class=widget__title>Recent Posts</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/posts/lab01-tidb%E6%80%BB%E4%BD%93%E6%9E%B6%E6%9E%84/>Lab01: TiDB总体架构</a></li></ul></div></div><div class="widget-categories widget"><h4 class=widget__title>Archives</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/2020/08/>2020/08
(1)</a></li></ul></div></div><div class="widget-categories widget"><h4 class=widget__title>Categories</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/categories/high-performance-tidb/>High Performance TiDB
(1)</a></li></ul></div></div><div class="widget-taglist widget"><h4 class=widget__title>Tags</h4><div class=widget__content><a class="widget-taglist__link widget__link btn" href=/tags/tidb/ title=TiDB>TiDB (1)</a></div></div></aside></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2021 Happy Hacking.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/hftsin/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>